/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a user-ownership model for user profiles and content,
 *              restricts access to moderation flags and ad banners to a trusted server environment,
 *              and allows public read access to posts and marketplace listings.
 *
 * Data Structure:
 * - /users/{userId}: User profiles, publicly readable but editable only by the owner.
 * - /products/{productId}: Marketplace listings, editable only by the seller.
 * - /lostAndFoundItems/{itemId}: Lost and found items, editable only by the user who posted the item.
 * - /messages/{messageId}: Messages, accessible to sender and receiver.
 * - /posts/{postId}: Posts, publicly readable but editable only by the author.
 * - /content_moderation_flags/{flagId}: Content moderation flags, write-only for trusted server.
 * - /ad_banners/{bannerId}: Ad banners, write-only for trusted server.
 *
 * Key Security Decisions:
 * - User listing is allowed for authenticated users to enable user discovery.
 * - User profiles are publicly readable to display author/seller info.
 * - Content Moderation Flags and Ad Banners can only be written to, never read from client side.
 * - Public read access is allowed for Posts and Marketplace Listings.
 *
 * Denormalization for Authorization:
 * - MarketplaceListing, LostAndFoundItem, and Post documents all have a userId (or sellerId) field
 *   to simplify ownership checks, avoiding the need for extra `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects user profiles, allowing only the authenticated user to manage their own profile, but allows public reads.
     * @path /users/{userId}
     * @allow (get) Any user can read any profile to see public info like name and avatar.
     * @allow (create) User with UID 'user123' creates a profile at /users/user123.
     * @allow (update) User with UID 'user123' updates their profile at /users/user123.
     * @allow (delete) User with UID 'user123' deletes their profile at /users/user123.
     * @deny (create) User with UID 'user456' attempts to create a profile at /users/user123.
     * @principle Enforces path-based ownership for writes, but allows public reads for display purposes.
     */
    match /users/{userId} {
      allow get: if true;
      allow list: if request.auth != null;
      allow create, update, delete: if request.auth.uid == userId;
    }

    /**
     * @description Manages marketplace listings, allowing anyone to read listings, but only the seller to modify them.
     * @path /products/{productId}
     * @allow (get) Any user can read a marketplace listing.
     * @allow (list) Any user can list marketplace listings.
     * @allow (create) User with UID 'user123' creates a listing with sellerId 'user123'.
     * @allow (update) User with UID 'user123' updates a listing where sellerId is already 'user123'.
     * @allow (delete) User with UID 'user123' deletes a listing where sellerId is 'user123'.
     * @deny (create) User with UID 'user123' creates a listing with sellerId 'user456'.
     * @deny (update) User with UID 'user456' attempts to update a listing where sellerId is 'user123'.
     * @deny (delete) User with UID 'user456' attempts to delete a listing where sellerId is 'user123'.
     * @principle Enforces document ownership for writes to marketplace listings.
     */
    match /products/{productId} {
      allow read: if true;
      allow create: if request.auth.uid == request.resource.data.sellerId;
      allow update, delete: if request.auth.uid == resource.data.sellerId;
    }

    /**
     * @description Manages lost and found items, allowing anyone to read items, but only the user who posted to modify them.
     * @path /lostAndFoundItems/{itemId}
     * @allow (get) Any user can read a lost and found item.
     * @allow (list) Any user can list lost and found items.
     * @allow (create) User with UID 'user123' creates an item with userId 'user123'.
     * @allow (update) User with UID 'user123' updates an item where userId is already 'user123'.
     * @allow (delete) User with UID 'user123' deletes an item where userId is 'user123'.
     * @deny (create) User with UID 'user123' creates an item with userId 'user456'.
     * @deny (update) User with UID 'user456' attempts to update an item where userId is 'user123'.
     * @deny (delete) User with UID 'user456' attempts to delete an item where userId is 'user123'.
     * @principle Enforces document ownership for writes to lost and found items.
     */
    match /lostAndFoundItems/{itemId} {
      allow read: if true;
      allow create: if request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth.uid == resource.data.userId;
    }

    /**
     * @description Manages messages, allowing only the sender or receiver to access the message.
     * @path /messages/{messageId}
     * @allow (get) User with UID 'user123' reads a message where senderId is 'user123'.
     * @allow (get) User with UID 'user456' reads a message where receiverId is 'user456'.
     * @allow (list) Sender with UID 'user123' can list their sent messages.
     * @deny (get) User with UID 'user456' attempts to read a message where senderId is 'user123' and receiverId is 'user789'.
     * @principle Enforces access control based on sender and receiver relationship.
     */
    match /messages/{messageId} {

      allow get: if request.auth != null && (request.auth.uid == resource.data.senderId || request.auth.uid == resource.data.receiverId);
      allow list: if request.auth != null && (request.auth.uid == resource.data.senderId || request.auth.uid == resource.data.receiverId);
      allow create: if request.auth != null && request.auth.uid == request.resource.data.senderId;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages posts, allowing anyone to read posts, but only the author to modify them.
     * @path /posts/{postId}
     * @allow (get) Any user can read a post.
     * @allow (list) Any user can list posts.
     * @allow (create) User with UID 'user123' creates a post with userId 'user123'.
     * @allow (update) User with UID 'user123' updates a post where userId is already 'user123'.
     * @allow (delete) User with UID 'user123' deletes a post where userId is 'user123'.
     * @deny (create) User with UID 'user123' creates a post with userId 'user456'.
     * @deny (update) User with UID 'user456' attempts to update a post where userId is 'user123'.
     * @deny (delete) User with UID 'user456' attempts to delete a post where userId is 'user123'.
     * @principle Enforces document ownership for writes to posts.
     */
    match /posts/{postId} {
      allow read, list: if true;
      allow create: if request.auth.uid == request.resource.data.authorId;
      allow update, delete: if request.auth.uid == resource.data.authorId;
    }

    /**
     * @description Restricts access to content moderation flags, allowing only trusted server environments to write.
     * @path /content_moderation_flags/{flagId}
     * @deny (get) Any user attempts to read a content moderation flag.
     * @deny (list) Any user attempts to list content moderation flags.
     * @allow (create) A trusted server creates a content moderation flag.
     * @principle Restricts write access to a trusted server environment.
     */
    match /content_moderation_flags/{flagId} {
      allow read: if false;
      allow write: if true;
    }

    /**
     * @description Restricts access to ad banners, allowing only trusted server environments to write.
     * @path /ad_banners/{bannerId}
     * @deny (get) Any user attempts to read an ad banner.
     * @deny (list) Any user attempts to list ad banners.
     * @allow (create) A trusted server creates an ad banner.
     * @principle Restricts write access to a trusted server environment.
     */
    match /ad_banners/{bannerId} {
      allow read: if false;
      allow write: if true;
    }
    
    match /conversations/{conversationId} {
      // Allow a user to list conversations they are part of.
      // The client-side query MUST use `where('participantIds', 'array-contains', request.auth.uid)`
      allow list: if request.auth != null;
      
      // Allow a user to read, create, or update a conversation document if they are a participant.
      allow get, create, update: if request.auth != null && request.auth.uid in resource.data.participantIds;

      match /messages/{messageId} {
         // A user can read/write messages in a conversation if they are a participant in that conversation.
         allow read, write: if request.auth != null && get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds.hasAny([request.auth.uid]);
      }
    }
  }
}
