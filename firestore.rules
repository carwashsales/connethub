/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a user-ownership model for user profiles and content,
 *              restricts access to moderation flags and ad banners to a trusted server environment,
 *              and allows public read access to posts and marketplace listings.
 *
 * Data Structure:
 * - /users/{userId}: User profiles, publicly readable but editable only by the owner.
 * - /products/{productId}: Marketplace listings, editable only by the seller.
 * - /lostAndFoundItems/{itemId}: Lost and found items, editable only by the user who posted the item.
 * - /messages/{messageId}: Messages, accessible to sender and receiver.
 * - /posts/{postId}: Posts, publicly readable but editable only by the author.
 * - /content_moderation_flags/{flagId}: Content moderation flags, write-only for trusted server.
 * - /ad_banners/{bannerId}: Ad banners, write-only for trusted server.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - User profiles are publicly readable to display author/seller info.
 * - Content Moderation Flags and Ad Banners can only be written to, never read from client side.
 * - Public read access is allowed for Posts and Marketplace Listings.
 *
 * Denormalization for Authorization:
 * - MarketplaceListing, LostAndFoundItem, and Post documents all have a userId (or sellerId) field
 *   to simplify ownership checks, avoiding the need for extra `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects user profiles, allowing only the authenticated user to manage their own profile, but allows public reads.
     * @path /users/{userId}
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow read: if true;
      allow list: if true;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Manages marketplace listings, allowing anyone to read listings, but only the seller to modify them.
     * @path /products/{productId}
     */
    match /products/{productId} {
      allow read: if true;
      allow create: if request.auth.uid == request.resource.data.sellerId;
      allow update: if request.auth.uid == resource.data.sellerId;
      allow delete: if request.auth.uid == resource.data.sellerId;
    }

    /**
     * @description Manages lost and found items, allowing anyone to read items, but only the user who posted to modify them.
     * @path /lostAndFoundItems/{itemId}
     */
    match /lostAndFoundItems/{itemId} {
      allow read: if true;
      allow create: if request.auth.uid == request.resource.data.userId;
      allow update: if request.auth.uid == resource.data.userId;
      allow delete: if request.auth.uid == resource.data.userId;
    }

    /**
     * @description Manages messages, allowing only the sender or receiver to access the message.
     * @path /messages/{messageId}
     */
    match /messages/{messageId} {
      allow read: if true;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.senderId;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages posts, allowing anyone to read posts, but only the author to modify them.
     * @path /posts/{postId}
     */
    match /posts/{postId} {
      allow read: if true;
      allow create: if request.auth.uid == request.resource.data.userId;
      allow update: if request.auth.uid == resource.data.userId;
      allow delete: if request.auth.uid == resource.data.userId;
    }

    /**
     * @description Restricts access to content moderation flags, allowing only trusted server environments to write.
     * @path /content_moderation_flags/{flagId}
     */
    match /content_moderation_flags/{flagId} {
      allow read: if false;
      allow write: if true;
    }

    /**
     * @description Restricts access to ad banners, allowing only trusted server environments to write.
     * @path /ad_banners/{bannerId}
     */
    match /ad_banners/{bannerId} {
      allow read: if false;
      allow write: if true;
    }
    
    match /conversations/{conversationId} {
      allow read: if true;
      
      // Allow a user to create a conversation if they are a participant and it only has two participants.
      allow create: if request.auth != null 
                    && request.auth.uid in request.resource.data.participantIds
                    && request.resource.data.participantIds.size() == 2;
      // Allow a user to update a conversation if they are a participant
      allow update: if request.auth != null && request.auth.uid in resource.data.participantIds;


      match /messages/{messageId} {
         // A user can read/write messages in a conversation.
         allow read: if true;
         allow write: if request.auth != null && get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds.hasAny([request.auth.uid]);
      }
    }
  }
}
